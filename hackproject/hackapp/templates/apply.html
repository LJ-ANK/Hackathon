{% extends 'my_base.html' %}
{% load static tailwind_tags %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/apply.css' %}">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let currentStep = 1;
            showStep(currentStep);
            console.log("DOM fully loaded, initializing steps"); // Debug

            function showStep(step) {
                document.querySelectorAll(".form-step").forEach(el => el.style.display = "none");
                document.getElementById("step" + step).style.display = "block";
                console.log("Showing step:", step); // Debug

                document.querySelectorAll(".timeline-step").forEach(el => el.classList.remove("active"));
                document.querySelectorAll(".timeline-line").forEach(el => el.classList.remove("active-line"));

                for (let i = 1; i <= step; i++) {
                    document.getElementById("timeline" + i).classList.add("active");
                    if (i > 1) {
                        document.getElementById("line" + (i - 1)).classList.add("active-line");
                    }
                }
            }

            document.querySelectorAll(".next-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    if (currentStep < 3) {
                        currentStep++;
                        showStep(currentStep);
                        if (currentStep === 2 && window.google && !window.mapInitialized) {
                            console.log("Step 2 shown, initializing map manually"); // Debug
                            initMap();
                            window.mapInitialized = true;
                        }
                    }
                });
            });

            document.querySelectorAll(".prev-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    if (currentStep > 1) {
                        currentStep--;
                        showStep(currentStep);
                    }
                });
            });
        });

        // Google Maps functions
        let map;
        let currentShape = null;

        function initMap() {
            console.log("initMap called"); // Debug
            const mapDiv = document.getElementById('map');
            if (!mapDiv) {
                console.error("Map div not found"); // Debug
                return;
            }
            console.log("Map div found, initializing map"); // Debug

            // Only initialize if Step 2 is visible
            if (document.getElementById("step2").style.display !== "block") {
                console.log("Step 2 not visible yet, deferring map init"); // Debug
                return;
            }

            map = new google.maps.Map(mapDiv, {
                center: { lat: 20.5937, lng: 78.9629 }, // Default to India center
                zoom: 5,
                mapTypeId: 'satellite'
            });

            const drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.CIRCLE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['circle', 'polygon']
                }
            });
            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (currentShape) {
                    currentShape.setMap(null);
                }
                currentShape = event.overlay;

                if (event.type === 'circle') {
                    const center = event.overlay.getCenter();
                    document.getElementById('latitude').value = center.lat().toFixed(6);
                    document.getElementById('longitude').value = center.lng().toFixed(6);
                    const bounds = event.overlay.getBounds();
                    map.fitBounds(bounds);
                    console.log("Circle drawn - Lat:", center.lat(), "Lng:", center.lng()); // Debug
                }
            });

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = { lat: position.coords.latitude, lng: position.coords.longitude };
                    map.setCenter(location);
                    map.setZoom(15);
                    console.log("Geolocation success - Lat:", location.lat, "Lng:", location.lng); // Debug
                },
                (error) => {
                    console.error('Geolocation Error:', error); // Debug
                }
            );

            window.mapInitialized = true; // Mark as initialized
            console.log("Map fully initialized"); // Debug
        }
    </script>
{% endblock head %}

{% block content %}
<div class="min-h-screen flex flex-col justify-between">
    <div class="container mx-auto p-4">
        <h2 class="text-2xl font-bold text-center">Apply for AgriCredit</h2>

        <!-- Timeline -->
        <div class="flex justify-center my-6">
            <div class="timeline flex w-full max-w-lg justify-between items-center">
                <div class="timeline-step active" id="timeline1">1</div>
                <div class="timeline-line" id="line1"></div>
                <div class="timeline-step" id="timeline2">2</div>
                <div class="timeline-line" id="line2"></div>
                <div class="timeline-step" id="timeline3">3</div>
            </div>
        </div>

        <form method="post" action="{% url 'apply' %}" class="bg-white p-6 rounded-lg shadow-lg">
            {% csrf_token %}
            
            <!-- Step 1: Personal Info -->
            <div id="step1" class="form-step">
                <h3 class="text-xl font-semibold">Personal Information</h3>
                <input type="text" name="farmer_name" placeholder="Farmer Name" class="input-field" required>
                <button type="button" class="next-btn btn">Next</button>
            </div>

            <!-- Step 2: Farm Info -->
            <div id="step2" class="form-step">
                <h3 class="text-xl font-semibold">Farm Information</h3>
                <input type="number" name="land_area" placeholder="Land Area (in acres)" class="input-field" step="0.01" required>
                <input type="text" name="crop_name" placeholder="Crop Name" class="input-field" required>
                <input type="text" name="water_availability" placeholder="Water Availability" class="input-field" required>
                <input type="text" name="land_ownership" placeholder="Land Ownership (e.g., Owned/Leased)" class="input-field" required>
                
                <!-- Google Maps Integration -->
                <div id="map" style="height: 300px; width: 100%; margin: 10px 0;"></div>
                <input type="text" id="latitude" name="latitude" placeholder="Latitude" class="input-field" readonly required>
                <input type="text" id="longitude" name="longitude" placeholder="Longitude" class="input-field" readonly required>

                <button type="button" class="prev-btn btn">Back</button>
                <button type="button" class="next-btn btn">Next</button>
            </div>

            <!-- Step 3: Financial Info -->
            <div id="step3" class="form-step">
                <h3 class="text-xl font-semibold">Financial Information</h3>
                <input type="number" name="assets_worth" placeholder="Assets Worth (in INR)" class="input-field" step="0.01" required>
                <input type="number" name="previous_loans" placeholder="Previous Loans (in INR)" class="input-field" step="0.01">
                <input type="number" name="paid_loans" placeholder="Paid Loans (in INR)" class="input-field" step="0.01">
                <input type="number" name="ongoing_loans" placeholder="Ongoing Loans (in INR)" class="input-field" step="0.01">
                <input type="text" name="assets_insurance_coverage" placeholder="Assets Insurance Coverage" class="input-field">
                <button type="button" class="prev-btn btn">Back</button>
                <button type="submit" class="submit-btn btn">Submit</button>
            </div>
        </form>
    </div>
</div>

<style>
    .timeline {
        display: flex;
        align-items: center;
        position: relative;
        width: 100%;
    }
    .timeline-step {
        padding: 10px;
        border-radius: 50%;
        background: #ddd;
        transition: 0.3s;
        font-size: 14px;
        font-weight: bold;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
    }
    .timeline-line {
        flex-grow: 1;
        height: 4px;
        background: #ddd;
        margin: 0 5px;
        position: relative;
        transition: 0.3s;
    }
    .timeline-step.active {
        background: #4CAF50;
        color: white;
    }
    .timeline-line.active-line {
        background: #4CAF50;
    }
    .form-step {
        display: none;
    }
    .input-field {
        display: block;
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .btn {
        padding: 10px 15px;
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block scripts %}
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmxEPn4nG87XqjAeZSwNCqx2-mP1xU7P0&libraries=drawing&callback=initMap" async defer></script>
{% endblock %}